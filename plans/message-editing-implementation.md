# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –ø–µ—Ä–µ—Å—ã–ª–∫–µ

## –¶–µ–ª—å
–í–º–µ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –∫–∞–∂–¥–æ–π –ø–µ—Ä–µ—Å—ã–ª–∫–µ, –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –û–î–ù–û —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –ø—Ä–∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –ø–µ—Ä–µ—Å—ã–ª–∫–∞—Ö —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Å—á–µ—Ç—á–∏–∫–æ–º.

## –¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –∫–∞–∂–¥–æ–π –ø–µ—Ä–µ—Å—ã–ª–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ `"‚úì {count}"` (handlers.js:97), —á—Ç–æ –∑–∞—Å–æ—Ä—è–µ—Ç —á–∞—Ç.

**–ü—Ä–∏–º–µ—Ä —Å–µ–π—á–∞—Å:**
```
User: [–ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ 1]
Bot: ‚úì 1

User: [–ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ 2]
Bot: ‚úì 2

User: [–ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ 3]
Bot: ‚úì 3
```

## –ñ–µ–ª–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
**–†–µ—à–µ–Ω–∏–µ**: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –ø—Ä–∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –ø–µ—Ä–µ—Å—ã–ª–∫–∞—Ö.

**–ü—Ä–∏–º–µ—Ä –ø–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
```
User: [–ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ 1]
Bot: üìù –ù–∞–∫–æ–ø–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: 1

User: [–ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ 2]
Bot: üìù –ù–∞–∫–æ–ø–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: 2  ‚Üê —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

User: [–ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ 3]
Bot: üìù –ù–∞–∫–æ–ø–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: 3  ‚Üê —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

#### 1.1 –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏
‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞**: `migrations/002_add_message_id.sql.applied`
- –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –∏–º–µ–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `.applied` (–Ω–µ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ)
- –°–æ–¥–µ—Ä–∂–∏—Ç: `ALTER TABLE sessions ADD COLUMN last_message_id INTEGER;`
- –ü–æ–ª–µ `last_message_id` —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü—É sessions

#### 1.2 –°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã sessions
```sql
CREATE TABLE sessions (
  id SERIAL PRIMARY KEY,
  user_id BIGINT UNIQUE NOT NULL,
  state VARCHAR(50) NOT NULL,
  messages JSONB DEFAULT '[]',
  last_instruction TEXT,
  last_message_id INTEGER,  -- ‚Üê —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –º–∏–≥—Ä–∞—Ü–∏–µ–π
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 1.3 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª**: `src/services/db.js`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `updateSession()` (—Å—Ç—Ä–æ–∫–∏ 135-164)**:

–¢–µ–∫—É—â–∏–π –∫–æ–¥:
```javascript
async function updateSession(userId, data) {
  const updates = [];
  const values = [];
  let paramIndex = 1;

  if (data.state !== undefined) {
    updates.push(`state = $${paramIndex++}`);
    values.push(data.state);
  }
  if (data.messages !== undefined) {
    updates.push(`messages = $${paramIndex++}`);
    values.push(JSON.stringify(data.messages));
  }
  if (data.last_instruction !== undefined) {
    updates.push(`last_instruction = $${paramIndex++}`);
    values.push(data.last_instruction);
  }

  updates.push(`updated_at = NOW()`);
  values.push(userId);

  const sql = `UPDATE sessions SET ${updates.join(', ')} WHERE user_id = $${paramIndex} RETURNING *`;
  const result = await pool.query(sql, values);
  return result.rows[0];
}
```

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É `last_message_id`:
```javascript
// –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 152 (–ø–æ—Å–ª–µ last_instruction) –¥–æ–±–∞–≤–∏—Ç—å:
if (data.last_message_id !== undefined) {
  updates.push(`last_message_id = $${paramIndex++}`);
  values.push(data.last_message_id);
}
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `resetSession()` (—Å—Ç—Ä–æ–∫–∏ 94-108)**:

–¢–µ–∫—É—â–∏–π SQL:
```sql
UPDATE sessions
SET state = $1, messages = '[]', last_instruction = NULL, updated_at = NOW()
WHERE user_id = $2
RETURNING *
```

–î–æ–±–∞–≤–∏—Ç—å —Å–±—Ä–æ—Å `last_message_id`:
```sql
UPDATE sessions
SET state = $1, messages = '[]', last_instruction = NULL, last_message_id = NULL, updated_at = NOW()
WHERE user_id = $2
RETURNING *
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `ensureSession()` (—Å—Ç—Ä–æ–∫–∏ 72-91)**:

–¢–µ–∫—É—â–∏–π SQL:
```sql
INSERT INTO sessions (user_id, state, messages, created_at, updated_at)
VALUES ($1, $2, '[]', NOW(), NOW())
ON CONFLICT (user_id)
DO UPDATE SET
  state = EXCLUDED.state,
  messages = '[]',
  last_instruction = NULL,
  updated_at = NOW()
RETURNING *
```

–î–æ–±–∞–≤–∏—Ç—å —Å–±—Ä–æ—Å `last_message_id`:
```sql
INSERT INTO sessions (user_id, state, messages, created_at, updated_at)
VALUES ($1, $2, '[]', NOW(), NOW())
ON CONFLICT (user_id)
DO UPDATE SET
  state = EXCLUDED.state,
  messages = '[]',
  last_instruction = NULL,
  last_message_id = NULL,  -- ‚Üê –¥–æ–±–∞–≤–∏—Ç—å
  updated_at = NOW()
RETURNING *
```

### 2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

#### 2.1 –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ handlers.js

**–§–∞–π–ª**: `src/handlers.js`
**–°—Ç—Ä–æ–∫–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è**: 90-97

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ (—Å—Ç—Ä–æ–∫–∏ 90-97):**
```javascript
// Add message to session
await db.addMessageToSession(userId, messageData);

// Get updated session to count messages
session = await db.getSession(userId);
const count = session.messages.length;

// Send confirmation
await bot.sendMessage(userId, `‚úì ${count}`);
```

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:**
```javascript
// Add message to session
await db.addMessageToSession(userId, messageData);

// Get updated session to count messages
session = await db.getSession(userId);
const count = session.messages.length;

// Send or edit confirmation message
const messageText = `üìù –ù–∞–∫–æ–ø–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${count}`;

try {
  if (session.last_message_id) {
    // Try to edit existing message
    await bot.editMessageText(messageText, {
      chat_id: userId,
      message_id: session.last_message_id
    });
  } else {
    // Send new message and save its ID
    const sentMessage = await bot.sendMessage(userId, messageText);
    await db.updateSession(userId, { last_message_id: sentMessage.message_id });
  }
} catch (error) {
  // Handle editing errors
  if (error.message.includes('message to edit not found') ||
      error.message.includes('message can\'t be edited') ||
      error.message.includes('MESSAGE_ID_INVALID')) {
    // Message was deleted or too old, send new one
    const sentMessage = await bot.sendMessage(userId, messageText);
    await db.updateSession(userId, { last_message_id: sentMessage.message_id });
  } else if (error.message.includes('message is not modified')) {
    // Text hasn't changed, ignore (shouldn't happen with counter)
    // Do nothing
  } else {
    // Unknown error, re-throw
    throw error;
  }
}
```

### 3. –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–±–æ—Ç—ã

#### 3.1 –ü–µ—Ä–≤–æ–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
1. User –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
2. Session —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `'collecting'`
3. –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ JSONB –º–∞—Å—Å–∏–≤
4. `session.last_message_id === null`
5. Bot –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: `"üìù –ù–∞–∫–æ–ø–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: 1"`
6. ID —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `session.last_message_id`

#### 3.2 –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
1. User –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –µ—â–µ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
2. Session —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `'collecting'`
3. –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ JSONB –º–∞—Å—Å–∏–≤
4. `session.last_message_id` —Å–æ–¥–µ—Ä–∂–∏—Ç ID –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
5. Bot —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: `"üìù –ù–∞–∫–æ–ø–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: 2"`
6. ID —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º

#### 3.3 –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è (–Ω–æ–≤—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫)
1. User –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –∞–≤—Ç–æ—Ä–∞
2. –í `handlers.js:37-40` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏
3. –ï—Å–ª–∏ `session.state !== 'collecting'`, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `resetSession()`
4. `resetSession()` —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç `last_message_id = NULL`
5. Bot –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ù–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ: `"üìù –ù–∞–∫–æ–ø–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: 1"`
6. –ù–æ–≤—ã–π ID —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

#### 3.4 –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
1. User –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
2. Bot –ø—ã—Ç–∞–µ—Ç—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å `session.last_message_id`
3. Telegram API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É: `"message to edit not found"`
4. –í `catch` –±–ª–æ–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
5. –ù–æ–≤—ã–π ID —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `session.last_message_id`

#### 3.5 –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä–æ–µ (>48 —á–∞—Å–æ–≤)
1. User –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ 48+ —á–∞—Å–æ–≤
2. Bot –ø—ã—Ç–∞–µ—Ç—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
3. Telegram API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É: `"message can't be edited"`
4. –í `catch` –±–ª–æ–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
5. –ù–æ–≤—ã–π ID —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Telegram API

#### 4.1 –¢–∏–ø—ã –æ—à–∏–±–æ–∫ `bot.editMessageText()`

| –û—à–∏–±–∫–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|--------|---------|---------|
| `message to edit not found` | –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º | –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ |
| `message can't be edited` | –°–æ–æ–±—â–µ–Ω–∏–µ —Å—Ç–∞—Ä—à–µ 48 —á–∞—Å–æ–≤ | –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ |
| `MESSAGE_ID_INVALID` | –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π ID | –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ |
| `message is not modified` | –¢–µ–∫—Å—Ç –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è | –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å |
| Other | –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ | –ü—Ä–æ–±—Ä–æ—Å–∏—Ç—å –≤—ã—à–µ |

#### 4.2 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```javascript
logger.warn('Message edit failed, sent new message', {
  userId,
  error: error.message,
  oldMessageId: session.last_message_id,
  newMessageId: sentMessage.message_id
});
```

### 5. –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π

#### 5.1 –§–æ—Ä–º–∞—Ç
```
üìù –ù–∞–∫–æ–ø–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {count}
```

#### 5.2 –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ
- **–≠–º–æ–¥–∑–∏ üìù**: –í–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø–æ–Ω—è—Ç–Ω—ã–π —Å–∏–º–≤–æ–ª "–¥–æ–∫—É–º–µ–Ω—Ç/–∑–∞–º–µ—Ç–∫–∞"
- **"–ù–∞–∫–æ–ø–ª–µ–Ω–æ"**: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∞–∫–∫—É–º—É–ª—è—Ü–∏–∏
- **"—Å–æ–æ–±—â–µ–Ω–∏–π"**: –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è
- **–°—á–µ—Ç—á–∏–∫**: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

#### 5.3 –í–∞—Ä–∏–∞–Ω—Ç—ã (–¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è)
- `üì® –°–æ–±—Ä–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {count}`
- `üí¨ –°–æ–æ–±—â–µ–Ω–∏–π –≤ –ø–∞–º—è—Ç–∏: {count}`
- `üì• –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {count}`

### 6. –í–ª–∏—è–Ω–∏–µ –Ω–∞ race conditions

#### 6.1 –¢–µ–∫—É—â–∞—è –∑–∞—â–∏—Ç–∞ (handlers.js:7-23)
```javascript
const userQueues = new Map();

async function processWithQueue(userId, handler) {
  if (!userQueues.has(userId)) {
    userQueues.set(userId, Promise.resolve());
  }
  const currentQueue = userQueues.get(userId);
  const newQueue = currentQueue.then(handler).catch(err => {...});
  userQueues.set(userId, newQueue);
  return newQueue;
}
```

#### 6.2 –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
‚úÖ **–ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**:
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `bot.editMessageText()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ `processWithQueue()`
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ –¥–≤–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ —á–µ—Ä–µ–∑ `updateSession()`

### 7. –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å db.js
1. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ (–ø–æ–ª–µ `last_message_id` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
2. –û–±–Ω–æ–≤–∏—Ç—å `updateSession()` - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É `last_message_id`
3. –û–±–Ω–æ–≤–∏—Ç—å `resetSession()` - —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å `last_message_id = NULL`
4. –û–±–Ω–æ–≤–∏—Ç—å `ensureSession()` - —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å `last_message_id = NULL`

#### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç—å handlers.js
1. –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –≤ —Å—Ç—Ä–æ–∫–∞—Ö 90-97
2. –ó–∞–º–µ–Ω–∏—Ç—å `bot.sendMessage()` –Ω–∞ –ª–æ–≥–∏–∫—É send/edit —Å try-catch
3. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç: `docker-compose up`
2. –ü–µ—Ä–µ—Å–ª–∞—Ç—å 1 —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
3. –ü–µ—Ä–µ—Å–ª–∞—Ç—å 2-–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
4. –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ ‚Üí –ø–µ—Ä–µ—Å–ª–∞—Ç—å 3-–µ ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
5. –ü–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –∞–≤—Ç–æ—Ä–∞ ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–±—Ä–æ—Å –∏ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
6. –ë—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ—Å–ª–∞—Ç—å 10 —Å–æ–æ–±—â–µ–Ω–∏–π ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—á–µ—Ç—á–∏–∫–∞

#### –®–∞–≥ 4: –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Winston –Ω–∞ –æ—à–∏–±–∫–∏
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É `statistics` –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø–∏—Å–µ–π
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É `sessions` - –ø–æ–ª–µ `last_message_id` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å UI —á–∞—Ç–∞ - —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—á–µ—Ç—á–∏–∫–æ–º

### 8. –†–∏—Å–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

#### 8.1 Telegram API –ª–∏–º–∏—Ç—ã
- ‚ö†Ô∏è **48 —á–∞—Å–æ–≤**: –°–æ–æ–±—â–µ–Ω–∏—è —Å—Ç–∞—Ä—à–µ 48 —á–∞—Å–æ–≤ –Ω–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ **–†–µ—à–µ–Ω–∏–µ**: –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ

#### 8.2 –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞**: User –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞
- ‚úÖ **–†–µ—à–µ–Ω–∏–µ**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ

#### 8.3 –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ **–£–ª—É—á—à–µ–Ω–∏–µ**: –ú–µ–Ω—å—à–µ —Å–æ–æ–±—â–µ–Ω–∏–π = –º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ API
- ‚úÖ **–£–ª—É—á—à–µ–Ω–∏–µ**: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ã—Å—Ç—Ä–µ–µ –æ—Ç–ø—Ä–∞–≤–∫–∏

#### 8.4 UX
- ‚úÖ **–£–ª—É—á—à–µ–Ω–∏–µ**: –ß–∞—Ç –Ω–µ –∑–∞—Å–æ—Ä—è–µ—Ç—Å—è –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ **–£–ª—É—á—à–µ–Ω–∏–µ**: –ü–æ–Ω—è—Ç–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### 9. –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (optional)

#### 9.1 –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
```
üìù –ù–∞–∫–æ–ø–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: 5
üë§ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫: Maria
üìÖ –ü–æ—Å–ª–µ–¥–Ω–µ–µ: 13:45
```

#### 9.2 –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
```
üìù –ù–∞–∫–æ–ø–ª–µ–Ω–æ: 3 ‚ñ∞‚ñ∞‚ñ∞‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±
```

#### 9.3 –ê–Ω–∏–º–∞—Ü–∏—è (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- Telegram API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—é —Ç–µ–∫—Å—Ç–∞
- –ò–∑–±—ã—Ç–æ—á–Ω—ã–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å rate limit

### 10. –ö–æ–¥ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

#### 10.1 db.js - updateSession() (–≤—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 152)
```javascript
if (data.last_message_id !== undefined) {
  updates.push(`last_message_id = $${paramIndex++}`);
  values.push(data.last_message_id);
}
```

#### 10.2 db.js - resetSession() (–∑–∞–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫—É 98)
```javascript
`UPDATE sessions
 SET state = $1, messages = '[]', last_instruction = NULL, last_message_id = NULL, updated_at = NOW()
 WHERE user_id = $2
 RETURNING *`,
```

#### 10.3 db.js - ensureSession() (–∑–∞–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ 75-82)
```javascript
`INSERT INTO sessions (user_id, state, messages, created_at, updated_at)
 VALUES ($1, $2, '[]', NOW(), NOW())
 ON CONFLICT (user_id)
 DO UPDATE SET
   state = EXCLUDED.state,
   messages = '[]',
   last_instruction = NULL,
   last_message_id = NULL,
   updated_at = NOW()
 RETURNING *`,
```

#### 10.4 handlers.js - –ø–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ —Å—Ç—Ä–æ–∫ 90-97
```javascript
// Add message to session
await db.addMessageToSession(userId, messageData);

// Get updated session to count messages
session = await db.getSession(userId);
const count = session.messages.length;

// Send or edit confirmation message
const messageText = `üìù –ù–∞–∫–æ–ø–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${count}`;

try {
  if (session.last_message_id) {
    // Try to edit existing message
    await bot.editMessageText(messageText, {
      chat_id: userId,
      message_id: session.last_message_id
    });
  } else {
    // Send new message and save its ID
    const sentMessage = await bot.sendMessage(userId, messageText);
    await db.updateSession(userId, { last_message_id: sentMessage.message_id });
  }
} catch (error) {
  // Handle editing errors
  if (error.message.includes('message to edit not found') ||
      error.message.includes('message can\'t be edited') ||
      error.message.includes('MESSAGE_ID_INVALID')) {
    // Message was deleted or too old, send new one
    logger.warn('Message edit failed, sending new message', {
      userId,
      error: error.message,
      oldMessageId: session.last_message_id
    });
    const sentMessage = await bot.sendMessage(userId, messageText);
    await db.updateSession(userId, { last_message_id: sentMessage.message_id });
  } else if (error.message.includes('message is not modified')) {
    // Text hasn't changed, ignore (shouldn't happen with counter but just in case)
    logger.debug('Message text not modified', { userId, count });
  } else {
    // Unknown error, re-throw to outer catch
    throw error;
  }
}
```

## –†–µ–∑—é–º–µ

**–ß—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è:**
1. ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –≥–æ—Ç–æ–≤–∞ (–º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞)
2. üîß –û–±–Ω–æ–≤–∏—Ç—å 3 —Ñ—É–Ω–∫—Ü–∏–∏ –≤ `db.js` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ `last_message_id`
3. üîß –ó–∞–º–µ–Ω–∏—Ç—å 8 —Å—Ç—Ä–æ–∫ –≤ `handlers.js` –Ω–∞ 30 —Å—Ç—Ä–æ–∫ —Å –ª–æ–≥–∏–∫–æ–π send/edit
4. ‚úÖ Race conditions —É–∂–µ –∑–∞—â–∏—â–µ–Ω—ã –æ—á–µ—Ä–µ–¥—å—é
5. ‚úÖ –í—Å–µ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ß–∏—â–µ UI (–æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞)
- –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ API
- –ü–æ–Ω—è—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ —Å—á–µ—Ç—á–∏–∫–æ–º
- –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

**–†–∏—Å–∫–∏:**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ (–≤—Å–µ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è)
- Fallback –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
